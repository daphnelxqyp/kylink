name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const info = `## ðŸ“‹ PR Information

            **Title:** ${pr.title}
            **Author:** @${pr.user.login}
            **Commits:** ${commits.data.length}
            **Files Changed:** ${files.data.length}
            **Additions:** +${pr.additions}
            **Deletions:** -${pr.deletions}

            ### Changed Files
            ${files.data.map(f => `- \`${f.filename}\` (+${f.additions} -${f.deletions})`).join('\n')}
            `;

            core.summary.addRaw(info).write();

  size-check:
    name: PR Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;

            let size = 'small';
            let emoji = 'âœ…';

            if (total > 1000) {
              size = 'extra-large';
              emoji = 'ðŸ”´';
            } else if (total > 500) {
              size = 'large';
              emoji = 'âš ï¸';
            } else if (total > 200) {
              size = 'medium';
              emoji = 'ðŸŸ¡';
            }

            const comment = `${emoji} **PR Size:** ${size} (${total} lines changed)

            ${total > 500 ? 'âš ï¸ This PR is quite large. Consider breaking it into smaller PRs for easier review.' : ''}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  test-required:
    name: Test Files Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for test files
        uses: actions/github-script@v7
        with:
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const sourceFiles = files.data.filter(f =>
              f.filename.match(/^src\/.*\.(ts|tsx)$/) &&
              !f.filename.includes('.test.') &&
              !f.filename.includes('.spec.')
            );

            const testFiles = files.data.filter(f =>
              f.filename.match(/\.(test|spec)\.(ts|tsx)$/)
            );

            if (sourceFiles.length > 0 && testFiles.length === 0) {
              const comment = `âš ï¸ **Missing Tests**

              This PR modifies ${sourceFiles.length} source file(s) but doesn't include any test files.

              Please consider adding tests for:
              ${sourceFiles.map(f => `- \`${f.filename}\``).join('\n')}
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
